
-- /nextjs_oem_frontend/src/app/account/invitation/[token]/page.tsx --
// app/account/invitation/[token]/page.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { useInvitation } from '../../../../lib/hooks/useInvitation';

export default function InvitationSignupPage() {
  const { token } = useParams();
  const router = useRouter();
  const { loading, error, validateToken, signupWithToken } = useInvitation();

  const [email, setEmail] = useState('');
  const [password1, setPassword1] = useState('');
  const [password2, setPassword2] = useState('');
  const [tokenValid, setTokenValid] = useState<boolean | null>(null);
  const [message, setMessage] = useState('');

  useEffect(() => {
    if (!token) {
      setTokenValid(false);
      setMessage('Token tidak ditemukan');
      return;
    }
    (async () => {
      const resp = await validateToken(token as string);
      if (resp && resp.id) {
        setTokenValid(true);
        setEmail((resp as any).email || '');
      } else {
        setTokenValid(false);
        setMessage(error || (resp as any)?.detail || 'Token tidak valid atau kadaluarsa');
      }
    })();
  }, [token, validateToken, error]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setMessage('');

    if (password1 !== password2) {
      setMessage('Password dan konfirmasi harus sama');
      return;
    }

    try {
      const resp: any = await signupWithToken({
        email,
        password1,
        password2,
        token: token as string,
      });

      if (resp && (resp as any).success) {
        // Kalau backend kasih pesan verifikasi email
        if (resp.detail?.toLowerCase().includes('verification')) {
          router.push('/account/verify-email');
        } else {
          router.push('/account');
        }
      } else {
        setMessage(resp?.detail || error || 'Pendaftaran gagal');
      }
    } catch (err: any) {
      setMessage(err?.data?.detail || err.message || 'Pendaftaran gagal');
    }
  };

  if (tokenValid === null) {
    return <p>Memverifikasi token...</p>;
  }

  if (!tokenValid) {
    return (
      <div className="container mt-5">
        <div className="alert alert-danger">{message}</div>
      </div>
    );
  }

  return (
    <div className="container mt-5">
      <h1 className="mb-4">Daftar dengan Undangan</h1>
      <form onSubmit={handleSubmit}>
        <div className="mb-3">
          <label htmlFor="email" className="form-label">Email</label>
          <input
            type="email"
            id="email"
            className="form-control"
            value={email}
            readOnly
          />
        </div>
        <div className="mb-3">
          <label htmlFor="password1" className="form-label">Password</label>
          <input
            type="password"
            id="password1"
            className="form-control"
            value={password1}
            onChange={(e) => setPassword1(e.target.value)}
            required
          />
        </div>
        <div className="mb-3">
          <label htmlFor="password2" className="form-label">Konfirmasi Password</label>
          <input
            type="password"
            id="password2"
            className="form-control"
            value={password2}
            onChange={(e) => setPassword2(e.target.value)}
            required
          />
        </div>
        {message && <div className="alert alert-warning">{message}</div>}
        <button type="submit" className="btn btn-success" disabled={loading}>
          {loading ? 'Memproses...' : 'Daftar'}
        </button>
      </form>
    </div>
  );
}


----------------------------------------


-- /nextjs_oem_frontend/src/app/account/signup/page.tsx --
// app/account/signup/page.tsx
'use client'

import React, { useState } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { mutate } from 'swr'

import { signUp, redirectToProvider, AuthProcess } from '../../../lib/allauth'
import { withAnonymous } from '../../../auth/AuthContext'
import { ClientOnly } from '../../../lib/helpers/ClientOnly'
import { useRequest } from '../../../lib/helpers/useRequest'
import { useAuthConfig } from '../../../lib/hooks/useAuthConfig'
import { waitForSessionCookie } from '../../../utils/cookies'

type Provider = { id: string; name?: string }

function SignupPage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const next = searchParams.get('next') || '/account'

  // Ambil konfigurasi via SWR
  const { data: rawConfig, error: configError, isLoading: loadingConfig } = useAuthConfig()

  const isSignupOpen = rawConfig?.data?.account?.is_open_for_signup ?? false
  const socialProviders = rawConfig?.data?.socialaccount?.providers ?? []

  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')

  const { trigger: doSignup, error: signupError, loading: loadingSignup } = useRequest(signUp)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    const resp = await doSignup({ email, password })
    if (resp?.meta?.is_authenticated) {
      await mutate('/auth/session')
      await waitForSessionCookie()
      router.push(next)
    }
  }

  if (loadingConfig) {
    return <div className="container mt-5">Memuat konfigurasi…</div>
  }
  if (configError) {
    return <div className="container mt-5 text-danger">Gagal memuat konfigurasi.</div>
  }

  return (
    <div className="container mt-5" style={{ maxWidth: 500 }}>
      <h2 className="mb-3">Daftar Akun</h2>

      {!isSignupOpen ? (
        <div className="alert alert-warning">
          <p className="mb-1">Pendaftaran akun baru ditutup.</p>
          <p className="mb-0">
            Ajukan permintaan undangan di{' '}
            <Link href="/account/invitation" className="text-primary">
              halaman undangan
            </Link>.
          </p>
        </div>
      ) : (
        <>
          <p>
            Sudah punya akun? <Link href="/account/login">Login di sini</Link>
          </p>

          {signupError && <div className="alert alert-danger">{signupError}</div>}

          <form onSubmit={handleSubmit} className="mb-4">
            <div className="mb-3">
              <label htmlFor="email" className="form-label">
                Email
              </label>
              <input
                id="email"
                type="email"
                className="form-control"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                disabled={loadingSignup}
              />
            </div>

            <div className="mb-3">
              <label htmlFor="password" className="form-label">
                Password
              </label>
              <input
                id="password"
                type="password"
                className="form-control"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                disabled={loadingSignup}
              />
            </div>

            <button type="submit" className="btn btn-primary" disabled={loadingSignup}>
              {loadingSignup ? 'Mendaftar…' : 'Daftar'}
            </button>
          </form>

          {socialProviders.length > 0 && (
            <div>
              <h5>Atau daftar dengan:</h5>
              <ul className="list-unstyled">
                {socialProviders.map((provider: Provider) => (
                  <li key={provider.id} className="mb-2">
                    <button
                      onClick={() =>
                        redirectToProvider(provider.id, '/account/provider/callback', AuthProcess.LOGIN)
                      }
                      className="btn btn-outline-secondary w-100"
                    >
                      Daftar dengan {provider.name ?? provider.id}
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </>
      )}
    </div>
  )
}

const AnonymousSignup = withAnonymous(SignupPage)

export default function SignupPageWrapper() {
  return (
    <ClientOnly>
      <AnonymousSignup />
    </ClientOnly>
  )
}


----------------------------------------

